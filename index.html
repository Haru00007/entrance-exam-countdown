<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>タイマー</title>
    <style>
        @font-face {
            font-family: 'DSEG7 Classic'; src: url('./fonts/DSEG7Classic-Bold.woff2') format('woff2');
            font-weight: bold; font-style: normal;
        }
        @font-face {
            font-family: 'DSEG14 Classic'; src: url('./fonts/DSEG14Classic-Bold.woff2') format('woff2');
            font-weight: bold; font-style: normal;
        }
        @font-face {
            font-family: 'LED Calculator'; src: url('./fonts/LEDCalculator.ttf') format('truetype');
        }
        @font-face {
            font-family: 'Ktai-Dot-Font-LCD'; src: url('./fonts/Ketai-dot-font-LCD.otf') format('opentype');
        }
        body {
            background-color: #000; font-family: 'DSEG7 Classic', sans-serif;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; margin: 0; text-align: center;
        }
        .container { transform: scale(1.5); }
        .countdown, .current-time { margin-bottom: 40px; }
        .dseg14 { font-family: 'DSEG14 Classic', sans-serif; }
        .countdown span, .current-time span { letter-spacing: 4px; }
        .space { margin: 0 10px; }
        [data-placeholder] { position: relative; }
        [data-placeholder]::before {
            content: attr(data-placeholder); position: absolute; top: 0; left: 0;
            width: 100%; height: 100%; color: rgba(255, 255, 255, 0.05);
        }
        #countdown-ms { font-size: 40px; color: white; }
        #day, #msec { color: orange; }
        #hour { font-size: 32px; color: red; position: relative; top: -2px; }
        #countdown-dh { font-size: 2em; }
        #current-date, #current-hms { font-size: 2em; color: white; }
        .jihou-highlight { color: red !important; transition: color 0.05s; }
        #day { display: inline-block; width: 115px; text-align: right; }
        #countdown-dh-labels {
            font-family: 'LED Calculator', sans-serif; font-size: 14px; color: orange;
            letter-spacing: 1px; margin-top: 5px; display: flex;
            justify-content: center; align-items: center;
        }
        #day-label { width: 120px; text-align: right; }
        #hour-label { width: 90px; text-align: right; }
        #msec-label { width: 120px; }
        #message-area {
            font-family: 'Ktai-Dot-Font-LCD', sans-serif; font-size: 24px;
            color: #0d0; letter-spacing: 2px; margin-bottom: 30px;
            height: 32px; line-height: 32px; position: relative;
        }
        #message-area::after {
            content: '_'; position: absolute; animation: blink 1s step-end infinite;
            font-family: 'LED Calculator', sans-serif;
        }
        #message-area.subject-mode {
            font-family: 'LED Calculator', sans-serif;
            font-size: 32px; letter-spacing: 1px;
        }
        #message-area.subject-mode::after {
            content: ''; animation: none;
        }
        @keyframes blink { 50% { opacity: 0; } }
        .timer-mode-container { display: none; }
        #switch-button-area { margin-bottom: 20px; display: flex; justify-content: center; gap: 10px; }
        .switch-btn {
            background: #333; color: #fff; border: 1px solid #555;
            padding: 5px 10px; font-family: sans-serif; font-size: 12px; cursor: pointer;
        }
        .switch-btn:active { background: #555; }
        #study-timer-display { font-size: 40px; color: white; height: 40px; }
        #study-timer-info {
            font-size: 2em;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #study-repeats-total, #study-program-number { color: orange; }
        #study-repeats-total { display: inline-block; width: 115px; text-align: right; }
        #study-program-number { display: inline-block; width: 115px; text-align: left; }
        #study-repeats-completed {
            color: red;
            font-size: 32px;
            position: relative;
            top: 8px;
            display: inline-block;
            width: 80px;
            text-align: center;
        }
        #study-timer-controls {
            margin-top: 10px; display: grid;
            grid-template-columns: repeat(6, 1fr);
            grid-gap: 5px;
        }
        #btn-pset { grid-column: 2 / span 2; }
        #btn-start-pause { grid-column: 4 / span 2; }
        .control-btn {
            background-color: transparent; border: none; color: orange;
            font-family: 'LED Calculator', sans-serif; font-size: 14px;
            padding: 8px 4px; cursor: pointer; opacity: 0.8;
        }
        .control-btn:hover { opacity: 1.0; }
        .control-btn:active { opacity: 0.6; }
        .control-btn.toggled { color: red; opacity: 1.0; }
        #records-container {
            font-family: 'LED Calculator', sans-serif;
            color: orange;
            font-size: 16px;
            text-align: left;
            width: 500px;
        }
        #log-list { margin-bottom: 10px; }
        #log-list .log-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .del-btn {
            background: none; border: none; color: red;
            font-family: 'LED Calculator', sans-serif;
            font-size: 16px; cursor: pointer; opacity: 0.7;
        }
        .del-btn:hover { opacity: 1.0; }
        #subject-summary {
            font-family: 'LED Calculator', sans-serif;
            white-space: pre;
            font-size: 16px;
            margin: 0;
        }
        #records-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
            margin-bottom: 10px;
        }
        #records-title {
            font-size: 20px;
            margin-top: 10px;
        }
        #graph-wrapper {
            display: flex;
            flex-direction: column;
        }
        #weekly-graph {
            font-family: 'LED Calculator', sans-serif;
            white-space: pre;
            font-size: 12px;
            margin: 0;
            text-align: left;
            margin-bottom: -5px;
            line-height: 1.0;
            color: #0d0;
        }
        #graph-x-axis {
            font-family: 'LED Calculator', sans-serif;
            font-size: 12px;
            white-space: pre;
            color: #0d0;
            line-height: 1.1;
        }
        .day-label {
            display: inline-block;
            cursor: pointer;
            padding: 2px 0;
            border-radius: 2px;
            width: 7ch;
            text-align: center;
        }
        .day-label:hover {
            background-color: rgba(0, 255, 0, 0.1);
        }
        .day-label.active {
            color: orange;
            background-color: rgba(255, 165, 0, 0.1);
        }
        #graph-nav {
            font-family: 'LED Calculator', sans-serif;
            font-size: 12px;
            color: #0d0;
            text-align: center;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            white-space: pre;
        }
        .nav-arrow, #week-range-display {
            cursor: pointer;
            padding: 0 10px;
        }
        .nav-arrow:hover, #week-range-display:hover {
            color: orange;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="message-area"></div>
        <div id="switch-button-area">
            <button id="switch-timer-btn" class="switch-btn">時間割タイマーへ</button>
            <button id="switch-records-btn" class="switch-btn">記録を見る</button>
        </div>
        <div id="countdown-container" class="timer-mode-container">
            <div class="countdown">
                <div id="countdown-ms"><span id="min" data-placeholder="88">00</span>:<span id="sec" data-placeholder="88">00</span></div>
                <div id="countdown-dh"><span id="day" data-placeholder="888">0</span><span class="space"></span><span id="hour" data-placeholder="88">00</span><span class="space"></span><span id="msec" data-placeholder="888">000</span></div>
                <div id="countdown-dh-labels"><span id="day-label" class="label-unit">Days</span><span class="space"></span><span id="hour-label" class="label-unit">Hours</span><span class="space"></span><span id="msec-label" class="label-unit">ms</span></div>
            </div>
            <div class="current-time">
                <div id="current-date"><span id="year" data-placeholder="8888">2025</span>-<span id="month" data-placeholder="88">09</span>-<span id="date" data-placeholder="88">22</span><span class="dseg14" id="day-of-week" data-placeholder="***">MON</span></div>
                <div id="current-hms"><span id="current-hour" data-placeholder="88">21</span>:<span id="current-min" data-placeholder="88">25</span>:<span id="current-sec" data-placeholder="88">15</span>.<span id="current-msec" data-placeholder="8">0</span></div>
            </div>
        </div>
        <div id="study-timer-container" class="timer-mode-container">
            <div id="study-timer-display" data-placeholder="88:88"></div>
            <div id="study-timer-info">
                <span id="study-repeats-total" data-placeholder="888"></span>
                <span class="space"></span>
                <span id="study-repeats-completed" data-placeholder="88"></span>
                <span class="space"></span>
                <span id="study-program-number" data-placeholder="P88"></span>
            </div>
            <div id="study-timer-controls">
                <button id="btn-plus-10m" class="control-btn">+10m</button><button id="btn-plus-1m" class="control-btn">+1m</button><button id="btn-plus-1s" class="control-btn">+1s</button><button id="btn-reset" class="control-btn">Reset</button><button id="btn-show-100s" class="control-btn">Show 1/100s</button><button id="btn-repeat-plus" class="control-btn">Repeat +1</button>
                <button id="btn-minus-10m" class="control-btn">-10m</button><button id="btn-minus-1m" class="control-btn">-1m</button><button id="btn-minus-1s" class="control-btn">-1s</button>
                <button id="btn-prev-subject" class="control-btn"><-</button><button id="btn-next-subject" class="control-btn">-></button>
                <button id="btn-repeat-minus" class="control-btn">Repeat -1</button>
                <button id="btn-pset" class="control-btn">P-Set</button><button id="btn-start-pause" class="control-btn">Start</button>
            </div>
        </div>
        <div id="records-container" class="timer-mode-container">
            <div id="records-header">
                <span id="records-title">Records</span>
                <div id="graph-wrapper">
                    <div id="graph-nav"></div>
                    <pre id="weekly-graph"></pre>
                    <div id="graph-x-axis"></div>
                </div>
            </div>
            <div id="log-list"></div>
            <pre id="subject-summary"></pre>
        </div>
    </div>

    <script>
        /*******************************************************************
         * 1. グローバル設定・定数
         *******************************************************************/
        
        const DEBUG_SPEED_MULTIPLIER = 1; 
        
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        let currentTimerMode = 'countdown';
        let previousTimerMode = 'countdown';
        const messageEl = document.getElementById('message-area');
        const switchBtn = document.getElementById('switch-timer-btn');
        const countdownContainer = document.getElementById('countdown-container');
        const studyTimerContainer = document.getElementById('study-timer-container');
        const minEl=document.getElementById('min'),secEl=document.getElementById('sec'),dayEl=document.getElementById('day'),hourEl=document.getElementById('hour'),msecEl=document.getElementById('msec'),yearEl=document.getElementById('year'),monthEl=document.getElementById('month'),dateEl=document.getElementById('date'),dayOfWeekEl=document.getElementById('day-of-week'),currentHourEl=document.getElementById('current-hour'),currentMinEl=document.getElementById('current-min'),currentSecEl=document.getElementById('current-sec'),currentMsecEl=document.getElementById('current-msec'),dayLabelEl=document.getElementById('day-label'),hourLabelEl=document.getElementById('hour-label'),currentHmsEl=document.getElementById('current-hms');
        const studyDisplayEl = document.getElementById('study-timer-display');
        const btnShow100s = document.getElementById('btn-show-100s');
        const btnStartPause = document.getElementById('btn-start-pause');
        const studyRepeatsTotalEl = document.getElementById('study-repeats-total');
        const studyRepeatsCompletedEl = document.getElementById('study-repeats-completed');
        const studyProgramNumberEl = document.getElementById('study-program-number');
        const switchRecordsBtn = document.getElementById('switch-records-btn');
        const recordsContainer = document.getElementById('records-container');
        const logListEl = document.getElementById('log-list');
        const subjectSummaryEl = document.getElementById('subject-summary');
        const recordsTitleEl = document.getElementById('records-title');
        const graphXAxisEl = document.getElementById('graph-x-axis');
        let filteredDayIndex = null;
        let weekOffset = 0;
        
        /*******************************************************************
         * 2. 共通テストタイマー関連 (変更なし)
         *******************************************************************/
        
        const targetDate = new Date("2026-01-17T00:00:00");
        const holidays = ['2025-01-01', '2025-01-13', '2025-02-11', '2025-02-24', '2025-03-20','2025-04-29', '2025-05-03', '2025-05-04', '2025-05-05', '2025-05-06','2025-07-21', '2025-08-11', '2025-09-15', '2025-09-23', '2025-10-13','2025-11-03', '2025-11-24'];
        const weekdays = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];
        let currentDays = 0, remainingHolidays = 0;
        let lastCheckedDate = null, lastSecond = -1, highlightUntil = 0;

        function calculateRemainingHolidays(target) {
            let holidayCount = 0; const today = new Date(); today.setHours(0, 0, 0, 0);
            for (let d = today; d < target; d.setDate(d.getDate() + 1)) {
                const dayOfWeek = d.getDay();
                const dateString = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                if (dayOfWeek === 0 || dayOfWeek === 6 || holidays.includes(dateString)) { holidayCount++; }
            }
            return holidayCount;
        }

        function updateCountdownTimer() {
            const now = new Date();
            if (now.getDate() !== lastCheckedDate) { remainingHolidays = calculateRemainingHolidays(targetDate); lastCheckedDate = now.getDate(); }
            const diff = targetDate.getTime() - now.getTime();
            if (diff > 0) {
                const days = Math.floor(diff/864e5), hours = Math.floor(diff%864e5/36e5), mins = Math.floor(diff%36e5/6e4), secs = Math.floor(diff%6e4/1e3), msecs = diff%1e3;
                currentDays = days;
                minEl.textContent = String(mins).padStart(2,"0"); secEl.textContent = String(secs).padStart(2,"0"); dayEl.textContent = String(days);
                hourEl.textContent = String(hours).padStart(2,"0"); msecEl.textContent = String(msecs).padStart(3,"0");
                dayLabelEl.textContent = 1 === days ? "Day" : "Days"; hourLabelEl.textContent = 1 === hours ? "Hour" : "Hours";
            }
            const currentHour = now.getHours(), currentMin = now.getMinutes(), currentSec = now.getSeconds();
            yearEl.textContent = String(now.getFullYear()).padStart(4,"0"); monthEl.textContent = String(now.getMonth()+1).padStart(2,"0"); dateEl.textContent = String(now.getDate()).padStart(2,"0");
            dayOfWeekEl.textContent = weekdays[now.getDay()]; currentHourEl.textContent = String(currentHour).padStart(2,"0"); currentMinEl.textContent = String(currentMin).padStart(2,"0");
            currentSecEl.textContent = String(currentSec).padStart(2,"0"); currentMsecEl.textContent = Math.floor(now.getMilliseconds()/100);
            if (currentSec !== lastSecond) { if (currentMin === 59 && (currentSec >= 57)) { highlightUntil = now.getTime() + 100; } lastSecond = currentSec; }
            const isJihou = (currentMin === 0 && currentSec < 5), isHighlighted = now.getTime() < highlightUntil;
            isJihou || isHighlighted ? currentHmsEl.classList.add("jihou-highlight") : currentHmsEl.classList.remove("jihou-highlight");
        }

        /*******************************************************************
         * 3. ランダムメッセージ関連 (変更なし)
         *******************************************************************/
        
        const randomMessages = ["キョウツウテストマデ アト DDDニチ!","シッテタ? キュウジツハアトddニチシカナインダヨ!","ナニヤッテルンデスカ、 ベンキョウシテクダサイ!","ガンバルアナタヲ オウエンシテイマス。","ヒトヤスミモ ダイジデスヨ。","モウコウコウモ オワッチャウネェ","トキノナガレハ ハヤイモノダヨ","ハナレバナレニ ナッテシマウノカナ...","ベンキョウ ガンバレヨ!","イママデノドリョクヲシンジテ。","キミナラデキル!","ラストスパートダ!","サイコウノハルヲムカエヨウ!","ムリシスギナイデネ。","ヒトリジャナイヨ。","アトスコシノシンボウ...","コンディションヲトトノエテ。","ケッカハカナラズツイテクル。","オワッタラ パーットアソボウゼ!"];
        const TYPING_SPEED = 150, DELETING_SPEED = 100, GREETING_STAY_DURATION = 5000;

        async function messageCycle() {
            if (currentTimerMode !== 'countdown') return;
            const type = async text => { for(let i=0; i < text.length; i++) { if (currentTimerMode !== 'countdown') { messageEl.textContent = ''; return false; } messageEl.textContent = text.substring(0, i + 1); await sleep(TYPING_SPEED); } return true; };
            const del = async () => { const currentText = messageEl.textContent; for(let i = currentText.length; i > 0; i--) { if (currentTimerMode !== 'countdown') { messageEl.textContent = ''; return false; } messageEl.textContent = currentText.substring(0, i - 1); await sleep(DELETING_SPEED); } return true; };
            const hour = new Date().getHours();
            let greeting = (hour >= 5 && hour < 10) ? "オハヨウゴザイマス" : (hour >= 10 && hour < 17) ? "コンニチハ" : "コンバンワ";
            if (!await type(greeting)) return;
            await sleep(GREETING_STAY_DURATION);
            if (!await del()) return;
            let rawMsg = randomMessages[Math.floor(Math.random() * randomMessages.length)];
            let processedMsg = rawMsg.replace('DDD', currentDays).replace('dd', remainingHolidays);
            if (!await type(processedMsg)) return;
            await sleep(5000 + Math.random() * 5000);
            if (!await del()) return;
        }

        async function runMessageLoop() {
            while (true) {
                if (currentTimerMode === 'countdown') { await messageCycle(); }
                await sleep(500);
            }
        }
        
        /*******************************************************************
         * 4. 時間割タイマー関連
         *******************************************************************/

        const subjects = ["Break", "Modern-Japanese", "Old-Japanese", "Old-Chinese", "Mathematics", "English", "Japan History", "World History", "Geography", "Physics", "Biology", "Science", "Information", "RANDOM"];
        let currentSubjectIndex = 0;
        let studyTimerState = 'setting', programs = [], settingTime = 0, runningTime = 0;
        let currentProgramIndex = 0, totalRepeats = 1, completedRepeats = 0;
        let showHundredths = false, timerInterval = null, isSettingProgram = false;
        let expectedEndTime = 0; 
        const chimeSound = new Audio('Chime.wav');
        let isAudioUnlocked = false;

        function unlockAudio() {
            if (isAudioUnlocked) return;
            chimeSound.volume = 0;
            chimeSound.play().then(() => {
                chimeSound.pause();
                chimeSound.currentTime = 0;
                chimeSound.volume = 1;
                isAudioUnlocked = true;
                console.log("Audio unlocked successfully.");
            }).catch(error => console.error("Audio unlock failed:", error));
        }
        
        function playChime() {
            if (!isAudioUnlocked) {
                console.warn("Audio is not unlocked yet. Cannot play chime.");
                return;
            }
            chimeSound.pause();
            chimeSound.currentTime = 0;
            chimeSound.play().catch(error => console.error("音声の再生に失敗しました:", error));
        }

        function updateStudyTimerDisplay() {
            let timeToShow = (studyTimerState === 'setting') ? settingTime * 1000 : runningTime;
            if (timeToShow < 0) timeToShow = 0;
            const totalSeconds = Math.floor(timeToShow / 1000), hours = Math.floor(totalSeconds / 3600), minutes = Math.floor((totalSeconds % 3600) / 60), seconds = totalSeconds % 60, hundredths = Math.floor((timeToShow % 1000) / 10);

            const minutesStr = (hours > 0) ? String(minutes).padStart(2, '0') : String(minutes).padStart(2, '!');
            studyDisplayEl.textContent = (showHundredths && totalSeconds < 60 && studyTimerState !== 'setting') 
                ? `${String(seconds).padStart(2, '0')}.${String(hundredths).padStart(2, '0')}` 
                : `${minutesStr}:${String(seconds).padStart(2, '0')}`;

            studyRepeatsCompletedEl.textContent = (hours > 0) ? String(hours).padStart(2, '!') : '!!';
            let displayRepeats;
            if (studyTimerState === 'setting') {
                displayRepeats = totalRepeats;
            } else {
                displayRepeats = (totalRepeats !== 0 && completedRepeats > totalRepeats) ? totalRepeats : completedRepeats;
            }
            studyRepeatsTotalEl.textContent = String(displayRepeats).padStart(3, '!');
            let programNumberToShow = (studyTimerState === 'setting') ? programs.length + 1 : currentProgramIndex + 1;
            const programNumberDigits = String(programNumberToShow).padStart(2, '0');
            studyProgramNumberEl.innerHTML = '';
            studyProgramNumberEl.textContent = `P${programNumberDigits}`;
        }
        
        function updateSubjectDisplay() {
            if (studyTimerState === 'setting' && !isSettingProgram) {
                messageEl.textContent = subjects[currentSubjectIndex];
            }
        }

        function updateRunningMessage() {
            if (!['running', 'paused', 'finished'].includes(studyTimerState) || programs.length === 0) return;
            const currentProgram = programs[currentProgramIndex];
            if (studyTimerState === 'paused') {
                messageEl.textContent = `${currentProgram.subject} (Paused)`; messageEl.style.fontSize = ''; return;
            }
            const endTimeFormatted = formatTime(expectedEndTime);
            if (currentProgram.subject === "Break") {
                const nextRep = (currentProgramIndex + 1 >= programs.length) ? (completedRepeats) : (completedRepeats - 1);
                if (totalRepeats !== 0 && nextRep >= totalRepeats) {
                    messageEl.textContent = 'Break (Last one!)';
                } else {
                    const nextIndex = (currentProgramIndex + 1) % programs.length;
                    const nextSubject = programs[nextIndex].subject;
                    messageEl.textContent = `Break (NEXT: ${nextSubject}, Starts at ${endTimeFormatted})`;
                }
                messageEl.style.fontSize = '29px';
            } else {
                messageEl.textContent = `${currentProgram.subject} (Ends at ${endTimeFormatted})`;
                messageEl.style.fontSize = '';
            }
        }
        
        function timerTick() {
            runningTime = expectedEndTime - Date.now();
            if (runningTime <= 0) {
                const finishedProgram = programs[currentProgramIndex];
                if (finishedProgram.subject !== 'Break') {
                    const startTime = expectedEndTime - (finishedProgram.time * 1000 / DEBUG_SPEED_MULTIPLIER);
                    addRecord(startTime, expectedEndTime, finishedProgram.subject);
                }
                playChime();
                currentProgramIndex++;
                if (currentProgramIndex >= programs.length) {
                    currentProgramIndex = 0;
                    completedRepeats++;
                    if (totalRepeats !== 0 && completedRepeats >= totalRepeats) {
                        studyTimerState = 'finished'; clearInterval(timerInterval); runningTime = 0;
                        messageEl.textContent = 'Your work is finished today!'; messageEl.style.fontSize = '';
                        btnStartPause.textContent = 'Finished'; updateStudyTimerDisplay(); return;
                    }
                }
                if (studyTimerState !== 'finished') {
                    runningTime = programs[currentProgramIndex].time * 1000;
                    expectedEndTime = Date.now() + (runningTime / DEBUG_SPEED_MULTIPLIER);
                    updateRunningMessage();
                }
            }
            updateStudyTimerDisplay();
        }

        function handleTimeChange(seconds) {
            if (studyTimerState !== 'setting' || isSettingProgram) return;
            settingTime += seconds;
            if (settingTime > 359999) settingTime = 359999;
            if (settingTime < 0) settingTime = 0;
            updateStudyTimerDisplay();
        }

        function handleRepeatChange(amount) {
            if (studyTimerState !== 'setting' || isSettingProgram) return;
            totalRepeats += amount;
            if (totalRepeats < 1) totalRepeats = 1;
            if (totalRepeats > 999) totalRepeats = 999;
            updateStudyTimerDisplay();
        }

        function resetStudyTimer() {
            clearInterval(timerInterval);
            studyTimerState = 'setting';
            programs = []; settingTime = 0; runningTime = 0;
            currentProgramIndex = 0; completedRepeats = 0;
            totalRepeats = 1;
            btnStartPause.textContent = 'Start';
            btnStartPause.classList.remove('toggled');
            messageEl.style.fontSize = '';
            currentSubjectIndex = 0;
            updateStudyTimerDisplay();
            updateSubjectDisplay();
        }
        
        /*******************************************************************
         * 6. 記録機能関連
         *******************************************************************/

        const subjectAbbreviations = { "Modern-Japanese": "M-JPN. ", "Old-Japanese": "O-JPN. ", "Old-Chinese": "O-CHN. ", "Mathematics": "Math.  ", "English": "ENG.   ", "Japan History": "J-Hist.", "World History": "W-Hist.", "Geography": "Geo.   ", "Physics": "Phy.   ", "Biology": "Bio.   ", "Science": "Sci.   ", "Information": "Info.  ", };
        const formatTime = (timestamp) => { const d = new Date(timestamp); return `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`; };
        const formatDuration = (ms) => { if (ms <= 0) return '0h00m'; const totalMins = Math.round(ms / 60000); const hours = Math.floor(totalMins / 60); const mins = totalMins % 60; return `${hours}h${String(mins).padStart(2, '0')}m`; };
        const formatGraphDate = d => {
            const m = String(d.getMonth() + 1);
            const day = String(d.getDate());
            return `${m.padStart(2, ' ')}-${day.padStart(2, ' ')}`;
        };
        const loadRecords = () => JSON.parse(localStorage.getItem('studyRecords') || '[]');
        const saveRecords = (records) => localStorage.setItem('studyRecords', JSON.stringify(records));

        function checkDailyReset() {
            const now = new Date();
            const lastResetStr = localStorage.getItem('lastReset');
            if (!lastResetStr) { localStorage.setItem('lastReset', now.getTime()); return; }
            const lastReset = new Date(parseInt(lastResetStr));
            let last4AM = new Date();
            last4AM.setHours(4, 0, 0, 0);
            if (now.getHours() < 4) { last4AM.setDate(last4AM.getDate() - 1); }
            if (lastReset < last4AM) {
                saveRecords([]);
                localStorage.setItem('lastReset', now.getTime());
            }
        }

        function addRecord(startTime, endTime, subject) {
            const records = loadRecords();
            records.push({ id: startTime, startTime, endTime, subject });
            saveRecords(records);
            if (currentTimerMode === 'records') renderRecords();
        }

        function deleteRecord(id) {
            let records = loadRecords();
            records = records.filter(r => r.id !== id);
            saveRecords(records);
            renderRecords();
        }

        function handleDayClick(dayIndex) {
            if (filteredDayIndex === dayIndex) {
                filteredDayIndex = null;
            } else {
                filteredDayIndex = dayIndex;
            }
            renderRecords();
        }

        function renderWeeklyGraph() {
            const graphEl = document.getElementById('weekly-graph');
            const graphNavEl = document.getElementById('graph-nav');
            const records = loadRecords();
            
            const today = new Date();
            today.setDate(today.getDate() + (weekOffset * 7));
            
            const dayOfWeek = today.getDay();
            const diffToMonday = (dayOfWeek === 0) ? -6 : 1 - dayOfWeek;
            const monday = new Date(today);
            monday.setDate(today.getDate() + diffToMonday);
            monday.setHours(0, 0, 0, 0);
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            sunday.setHours(23, 59, 59, 999);
            
            // ▼▼▼▼▼ 変更箇所 (イベントリスナーの追加を削除) ▼▼▼▼▼
            graphNavEl.innerHTML = `
                <span class="nav-arrow" id="prev-week-btn">&lt;-</span>
                <span id="week-range-display">${formatGraphDate(monday)} - ${formatGraphDate(sunday)}</span>
                <span class="nav-arrow" id="next-week-btn">-&gt;</span>
            `;
            // ▲▲▲▲▲ 変更箇所 ▲▲▲▲▲

            const dailyTotals = Array(7).fill(0);
            for (const record of records) {
                const recordDate = new Date(record.startTime);
                if (recordDate >= monday && recordDate <= sunday) {
                    const recordDayIndex = (recordDate.getDay() + 6) % 7;
                    dailyTotals[recordDayIndex] += (record.endTime - record.startTime);
                }
            }

            const maxMs = Math.max(...dailyTotals, 1);
            const maxHours = maxMs / 3600000;
            let yAxisMaxHours = (maxHours > 0) ? Math.ceil(maxHours / 2) * 2 : 2;
            if (yAxisMaxHours > 16) yAxisMaxHours = 16;

            const GRAPH_HEIGHT = 16;
            const lines = [];
            const dayLabels = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];

            for (let i = GRAPH_HEIGHT; i >= 0; i--) {
                let line = '';
                const currentLineHour = (i / GRAPH_HEIGHT) * yAxisMaxHours;

                if (i % 4 === 0) {
                    let labelText = `${currentLineHour}h`;
                    line += labelText.padEnd(3, ' ') + '|';
                } else {
                    line += '   |';
                }
                
                if (i === 0) {
                    line += '-'.repeat(49);
                } else {
                    for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                        const dayHours = dailyTotals[dayIndex] / 3600000;
                        if (dayHours >= currentLineHour) {
                            line += '   -   ';
                        } else {
                            line += '       ';
                        }
                    }
                }
                lines.push(line);
            }
            graphEl.textContent = lines.join('\n');

            graphXAxisEl.innerHTML = '';
            const labelsContainer = document.createElement('div');
            labelsContainer.textContent = '    ';
            dayLabels.forEach((label, index) => {
                const labelSpan = document.createElement('span');
                labelSpan.textContent = label;
                labelSpan.className = 'day-label';
                if (index === filteredDayIndex) {
                    labelSpan.classList.add('active');
                }
                labelSpan.dataset.dayIndex = index;
                labelSpan.addEventListener('click', () => handleDayClick(index));
                labelsContainer.appendChild(labelSpan);
            });
            graphXAxisEl.appendChild(labelsContainer);
        }

        function renderRecords() {
            const records = loadRecords();
            logListEl.innerHTML = '';
            
            const today = new Date();
            today.setDate(today.getDate() + (weekOffset * 7));
            
            const dayOfWeek = today.getDay();
            const diffToMonday = (dayOfWeek === 0) ? -6 : 1 - dayOfWeek;
            const monday = new Date(today);
            monday.setDate(today.getDate() + diffToMonday);
            monday.setHours(0, 0, 0, 0);

            let recordsToDisplay = records;

            if (filteredDayIndex !== null) {
                const targetDate = new Date(monday);
                targetDate.setDate(monday.getDate() + filteredDayIndex);
                const year = targetDate.getFullYear(), month = targetDate.getMonth(), date = targetDate.getDate();

                const dayStr = weekdays[(filteredDayIndex + 1) % 7];
                recordsTitleEl.textContent = `Records of ${month + 1}-${date}(${dayStr})`;

                recordsToDisplay = records.filter(r => {
                    const recordDate = new Date(r.startTime);
                    return recordDate.getFullYear() === year && recordDate.getMonth() === month && recordDate.getDate() === date;
                });
            } else {
                 recordsTitleEl.textContent = (weekOffset === 0) ? 'This Week Records' : 'Records';
            }

            const subjectTotals = {};
            let grandTotal = 0;
            for (const record of recordsToDisplay) {
                const recordDate = new Date(record.startTime);
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                sunday.setHours(23, 59, 59, 999);
                if (filteredDayIndex === null && (recordDate < monday || recordDate > sunday)) {
                    continue;
                }

                const duration = record.endTime - record.startTime;
                grandTotal += duration;
                subjectTotals[record.subject] = (subjectTotals[record.subject] || 0) + duration;
                const logItem = document.createElement('div');
                logItem.className = 'log-item';
                logItem.innerHTML = `
                    <span>${formatTime(record.startTime)}-${formatTime(record.endTime)} ${record.subject} (${formatDuration(duration)})</span>
                    <button class="del-btn" data-id="${record.id}">[Del]</button>
                `;
                logListEl.appendChild(logItem);
            }

            let summaryText = '-------------------------------------\nTotal (By Subjects)\n-------------------------------------\n';
            for (const subject in subjectAbbreviations) {
                const totalMs = subjectTotals[subject] || 0;
                if (totalMs > 0) {
                    summaryText += `${subjectAbbreviations[subject]}|${formatDuration(totalMs)}\n`;
                }
            }
            summaryText += '-------------------------------------\n';
            summaryText += `Total  |${formatDuration(grandTotal)}\n`;
            const weeklyAverage = grandTotal / 7;
            summaryText += `Avg.   |${formatDuration(weeklyAverage)}`;
            subjectSummaryEl.textContent = summaryText;

            renderWeeklyGraph();
        }
        
        /*******************************************************************
         * 7. メイン制御・初期化
         *******************************************************************/

        function makeButtonAccelerate(element, action) {
            let timeoutId, intervalId;
            const startAction = (e) => {
                e.preventDefault(); unlockAudio(); action();
                timeoutId = setTimeout(() => { intervalId = setInterval(action, 100); }, 500);
            };
            const stopAction = () => { clearTimeout(timeoutId); clearInterval(intervalId); };
            element.addEventListener('mousedown', startAction);
            element.addEventListener('mouseup', stopAction);
            element.addEventListener('mouseleave', stopAction);
            element.addEventListener('touchstart', startAction);
            element.addEventListener('touchend', stopAction);
        }
        
        // ▼▼▼▼▼ 追加箇所 (グラフナビゲーションの連続操作機能) ▼▼▼▼▼
        function setupGraphNavControls() {
            const graphNavEl = document.getElementById('graph-nav');
            let navTimeoutId, navIntervalId;

            const handleNav = (direction) => {
                if (direction === 0) { // 現在週に戻る
                    weekOffset = 0;
                } else {
                    weekOffset += direction;
                }
                renderRecords();
            };

            const startNavAction = (e) => {
                e.preventDefault();
                let direction = 0;
                if (e.target.id === 'prev-week-btn') direction = -1;
                if (e.target.id === 'next-week-btn') direction = 1;
                if (e.target.id === 'week-range-display') {
                    handleNav(0); // 日付部分クリックで現在週へ
                    return;
                }

                if (direction !== 0) {
                    handleNav(direction);
                    navTimeoutId = setTimeout(() => {
                        navIntervalId = setInterval(() => handleNav(direction), 100);
                    }, 500);
                }
            };

            const stopNavAction = () => {
                clearTimeout(navTimeoutId);
                clearInterval(navIntervalId);
            };

            graphNavEl.addEventListener('mousedown', startNavAction);
            graphNavEl.addEventListener('mouseup', stopNavAction);
            graphNavEl.addEventListener('mouseleave', stopNavAction);
            graphNavEl.addEventListener('touchstart', startNavAction, { passive: false });
            graphNavEl.addEventListener('touchend', stopNavAction);
        }
        // ▲▲▲▲▲ 追加箇所 ▲▲▲▲▲

        function setupEventListeners() {
            switchBtn.addEventListener('click', () => {
                unlockAudio();
                if (currentTimerMode === 'records') {
                    currentTimerMode = previousTimerMode;
                } else {
                    currentTimerMode = currentTimerMode === 'countdown' ? 'study' : 'countdown';
                    if (currentTimerMode === 'study') resetStudyTimer();
                }
                
                countdownContainer.style.display = currentTimerMode === 'countdown' ? 'block' : 'none';
                studyTimerContainer.style.display = currentTimerMode === 'study' ? 'block' : 'none';
                recordsContainer.style.display = 'none';

                if (currentTimerMode === 'countdown') {
                    switchBtn.textContent = '時間割タイマーへ';
                    messageEl.classList.remove('subject-mode');
                } else {
                    switchBtn.textContent = '共通テストタイマーへ';
                    messageEl.classList.add('subject-mode');
                }
                messageEl.style.fontSize = '';
            });

            switchRecordsBtn.addEventListener('click', () => {
                unlockAudio();
                if (currentTimerMode !== 'records') {
                    previousTimerMode = currentTimerMode; 
                }
                currentTimerMode = 'records';
                countdownContainer.style.display = 'none';
                studyTimerContainer.style.display = 'none';
                recordsContainer.style.display = 'block';
                switchBtn.textContent = '戻る';
                filteredDayIndex = null;
                weekOffset = 0;
                renderRecords();
            });

            logListEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('del-btn')) {
                    const recordId = parseInt(e.target.dataset.id);
                    deleteRecord(recordId);
                }
            });

            makeButtonAccelerate(document.getElementById('btn-plus-10m'), () => handleTimeChange(600));
            makeButtonAccelerate(document.getElementById('btn-plus-1m'), () => handleTimeChange(60));
            makeButtonAccelerate(document.getElementById('btn-plus-1s'), () => handleTimeChange(1));
            makeButtonAccelerate(document.getElementById('btn-minus-10m'), () => handleTimeChange(-600));
            makeButtonAccelerate(document.getElementById('btn-minus-1m'), () => handleTimeChange(-60));
            makeButtonAccelerate(document.getElementById('btn-minus-1s'), () => handleTimeChange(-1));
            makeButtonAccelerate(document.getElementById('btn-repeat-plus'), () => handleRepeatChange(1));
            makeButtonAccelerate(document.getElementById('btn-repeat-minus'), () => handleRepeatChange(-1));
            
            // ▼▼▼▼▼ 変更箇所 (教科送りボタンのイベントリスナー) ▼▼▼▼▼
            const nextSubjectAction = () => {
                if (studyTimerState !== 'setting' || isSettingProgram) return;
                currentSubjectIndex = (currentSubjectIndex + 1) % subjects.length;
                updateSubjectDisplay();
            };
            const prevSubjectAction = () => {
                if (studyTimerState !== 'setting' || isSettingProgram) return;
                currentSubjectIndex = (currentSubjectIndex - 1 + subjects.length) % subjects.length;
                updateSubjectDisplay();
            };
            makeButtonAccelerate(document.getElementById('btn-next-subject'), nextSubjectAction);
            makeButtonAccelerate(document.getElementById('btn-prev-subject'), prevSubjectAction);
            // ▲▲▲▲▲ 変更箇所 ▲▲▲▲▲

            document.getElementById('btn-reset').addEventListener('click', resetStudyTimer);
            btnShow100s.addEventListener('click', () => {
                showHundredths = !showHundredths; btnShow100s.classList.toggle('toggled', showHundredths); updateStudyTimerDisplay();
            });
            
            document.getElementById('btn-pset').addEventListener('click', async () => {
                if (studyTimerState !== 'setting' || settingTime === 0 || programs.length >= 99 || isSettingProgram) return;
                unlockAudio(); isSettingProgram = true;
                let subjectToSet = subjects[currentSubjectIndex];
                if (subjectToSet === 'RANDOM') {
                    const candidateSubjects = subjects.filter(s => s !== 'Break' && s !== 'RANDOM');
                    subjectToSet = candidateSubjects[Math.floor(Math.random() * candidateSubjects.length)];
                }
                programs.push({ time: settingTime, subject: subjectToSet });
                const programNumberStr = String(programs.length).padStart(2, '0');
                messageEl.textContent = `P${programNumberStr} is set to ${subjectToSet}`;
                settingTime = 0;
                updateStudyTimerDisplay();
                await sleep(2000);
                currentSubjectIndex = 0; isSettingProgram = false; updateSubjectDisplay();
            });

            btnStartPause.addEventListener('click', () => {
                if (isSettingProgram || studyTimerState === 'finished') return;
                unlockAudio();
                if (studyTimerState === 'setting') {
                    if (programs.length === 0 && settingTime > 0) {
                        let subjectToSet = subjects[currentSubjectIndex];
                        if (subjectToSet === 'RANDOM') {
                            const candidateSubjects = subjects.filter(s => s !== 'Break' && s !== 'RANDOM');
                            subjectToSet = candidateSubjects[Math.floor(Math.random() * candidateSubjects.length)];
                        }
                        programs.push({ time: settingTime, subject: subjectToSet });
                        settingTime = 0;
                    }
                    if (programs.length === 0) return;
                    studyTimerState = 'running';
                    currentProgramIndex = 0; completedRepeats = 0; updateStudyTimerDisplay(); completedRepeats = 1;
                    runningTime = programs[0].time * 1000;
                    expectedEndTime = Date.now() + (runningTime / DEBUG_SPEED_MULTIPLIER);
                    updateRunningMessage();
                    timerInterval = setInterval(timerTick, 10);
                    btnStartPause.textContent = 'Pause'; btnStartPause.classList.add('toggled');
                } else if (studyTimerState === 'running') {
                    studyTimerState = 'paused'; clearInterval(timerInterval);
                    runningTime = expectedEndTime - Date.now();
                    btnStartPause.textContent = 'Resume';
                    updateRunningMessage();
                } else if (studyTimerState === 'paused') {
                    studyTimerState = 'running';
                    expectedEndTime = Date.now() + runningTime;
                    updateRunningMessage();
                    timerInterval = setInterval(timerTick, 10);
                    btnStartPause.textContent = 'Pause';
                }
            });
        }

        function initialize() {
            checkDailyReset();
            countdownContainer.style.display = 'block';
            setInterval(updateCountdownTimer, 1);
            runMessageLoop();
            resetStudyTimer();
            setupEventListeners();
            // ▼▼▼▼▼ 追加箇所 ▼▼▼▼▼
            setupGraphNavControls(); // グラフナビゲーションのイベントリスナーを一度だけ設定
            // ▲▲▲▲▲ 追加箇所 ▲▲▲▲▲
        }
        
        initialize();

    </script>
</body>
</html>