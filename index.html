<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>タイマー</title>
    <style>
        /* (CSSに変更はありません) */
        @font-face {
            font-family: 'DSEG7 Classic'; src: url('./fonts/DSEG7Classic-Bold.woff2') format('woff2');
            font-weight: bold; font-style: normal;
        }
        @font-face {
            font-family: 'DSEG14 Classic'; src: url('./fonts/DSEG14Classic-Bold.woff2') format('woff2');
            font-weight: bold; font-style: normal;
        }
        @font-face {
            font-family: 'LED Calculator'; src: url('./fonts/LEDCALCULATOR.TTF') format('truetype');
        }
        @font-face {
            font-family: 'Ktai-Dot-Font-LCD'; src: url('./fonts/Ketai-dot-font-LCD.otf') format('opentype');
        }
        body {
            background-color: #000; font-family: 'DSEG7 Classic', sans-serif;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; margin: 0; text-align: center;
        }
        .container { transform: scale(1.5); }
        .countdown, .current-time { margin-bottom: 40px; }
        .dseg14 { font-family: 'DSEG14 Classic', sans-serif; }
        .countdown span, .current-time span { letter-spacing: 4px; }
        .space { margin: 0 10px; }
        [data-placeholder] { position: relative; }
        [data-placeholder]::before {
            content: attr(data-placeholder); position: absolute; top: 0; left: 0;
            width: 100%; height: 100%; color: rgba(255, 255, 255, 0.05);
        }
        #countdown-ms { font-size: 40px; color: white; }
        #day, #msec { color: orange; }
        #hour { font-size: 32px; color: red; position: relative; top: -2px; }
        #countdown-dh { font-size: 2em; }
        #current-date, #current-hms { font-size: 2em; color: white; }
        .jihou-highlight { color: red !important; transition: color 0.05s; }
        #day { display: inline-block; width: 115px; text-align: right; }
        #countdown-dh-labels {
            font-family: 'LED Calculator', sans-serif; font-size: 14px; color: orange;
            letter-spacing: 1px; margin-top: 5px; display: flex;
            justify-content: center; align-items: center;
        }
        #day-label { width: 120px; text-align: right; }
        #hour-label { width: 90px; text-align: right; }
        #msec-label { width: 120px; }
        #message-area {
            font-family: 'Ktai-Dot-Font-LCD', sans-serif; font-size: 24px;
            color: #0d0; letter-spacing: 2px; margin-bottom: 30px;
            height: 32px; line-height: 32px; position: relative;
        }
        #message-area::after {
            content: '_'; position: absolute; animation: blink 1s step-end infinite;
            font-family: 'LED Calculator', sans-serif;
        }
        #message-area.subject-mode {
            font-family: 'LED Calculator', sans-serif;
            font-size: 32px; letter-spacing: 1px;
        }
        #message-area.subject-mode::after {
            content: ''; animation: none;
        }
        @keyframes blink { 50% { opacity: 0; } }
        .timer-mode-container { display: none; }
        #switch-button-area { margin-bottom: 20px; }
        .switch-btn {
            background: #333; color: #fff; border: 1px solid #555;
            padding: 5px 10px; font-family: sans-serif; font-size: 12px; cursor: pointer;
        }
        .switch-btn:active { background: #555; }
        #study-timer-display { font-size: 40px; color: white; height: 40px; }
        #study-timer-info {
            font-size: 2em;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #study-repeats-total, #study-program-number { color: orange; }
        #study-repeats-total { display: inline-block; width: 115px; text-align: right; }
        #study-program-number { display: inline-block; width: 115px; text-align: left; }
        #study-repeats-completed {
            color: red;
            font-size: 32px;
            position: relative;
            top: 8px;
            display: inline-block;
            width: 80px;
            text-align: center;
        }
        #study-timer-controls {
            margin-top: 10px; display: grid;
            grid-template-columns: repeat(6, 1fr);
            grid-gap: 5px;
        }
        #btn-pset { grid-column: 2 / span 2; }
        #btn-start-pause { grid-column: 4 / span 2; }
        .control-btn {
            background-color: transparent; border: none; color: orange;
            font-family: 'LED Calculator', sans-serif; font-size: 14px;
            padding: 8px 4px; cursor: pointer; opacity: 0.8;
        }
        .control-btn:hover { opacity: 1.0; }
        .control-btn:active { opacity: 0.6; }
        .control-btn.toggled { color: red; opacity: 1.0; }
    </style>
</head>
<body>
    <div class="container">
        <!-- (HTMLは変更なし) -->
        <div id="message-area"></div>
        <div id="switch-button-area"><button id="switch-timer-btn" class="switch-btn">時間割タイマーへ</button></div>
        <div id="countdown-container" class="timer-mode-container">
            <div class="countdown">
                <div id="countdown-ms"><span id="min" data-placeholder="88">00</span>:<span id="sec" data-placeholder="88">00</span></div>
                <div id="countdown-dh"><span id="day" data-placeholder="888">0</span><span class="space"></span><span id="hour" data-placeholder="88">00</span><span class="space"></span><span id="msec" data-placeholder="888">000</span></div>
                <div id="countdown-dh-labels"><span id="day-label" class="label-unit">Days</span><span class="space"></span><span id="hour-label" class="label-unit">Hours</span><span class="space"></span><span id="msec-label" class="label-unit">ms</span></div>
            </div>
            <div class="current-time">
                <div id="current-date"><span id="year" data-placeholder="8888">2025</span>-<span id="month" data-placeholder="88">09</span>-<span id="date" data-placeholder="88">22</span><span class="dseg14" id="day-of-week" data-placeholder="***">MON</span></div>
                <div id="current-hms"><span id="current-hour" data-placeholder="88">21</span>:<span id="current-min" data-placeholder="88">25</span>:<span id="current-sec" data-placeholder="88">15</span>.<span id="current-msec" data-placeholder="8">0</span></div>
            </div>
        </div>
        <div id="study-timer-container" class="timer-mode-container">
            <div id="study-timer-display" data-placeholder="88:88"></div>
            <div id="study-timer-info">
                <span id="study-repeats-total" data-placeholder="888"></span>
                <span class="space"></span>
                <span id="study-repeats-completed" data-placeholder="88"></span>
                <span class="space"></span>
                <span id="study-program-number" data-placeholder="P88"></span>
            </div>
            <div id="study-timer-controls">
                <button id="btn-plus-10m" class="control-btn">+10m</button><button id="btn-plus-1m" class="control-btn">+1m</button><button id="btn-plus-1s" class="control-btn">+1s</button><button id="btn-reset" class="control-btn">Reset</button><button id="btn-show-100s" class="control-btn">Show 1/100s</button><button id="btn-repeat-plus" class="control-btn">Repeat +1</button>
                <button id="btn-minus-10m" class="control-btn">-10m</button><button id="btn-minus-1m" class="control-btn">-1m</button><button id="btn-minus-1s" class="control-btn">-1s</button>
                <button id="btn-prev-subject" class="control-btn"><-</button><button id="btn-next-subject" class="control-btn">-></button>
                <button id="btn-repeat-minus" class="control-btn">Repeat -1</button>
                <button id="btn-pset" class="control-btn">P-Set</button><button id="btn-start-pause" class="control-btn">Start</button>
            </div>
        </div>
    </div>

    <script>
        /*******************************************************************
         * 1. グローバル設定・定数
         *******************************************************************/

        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        let currentTimerMode = 'countdown';
        const messageEl = document.getElementById('message-area');
        const switchBtn = document.getElementById('switch-timer-btn');
        const countdownContainer = document.getElementById('countdown-container');
        const studyTimerContainer = document.getElementById('study-timer-container');
        const minEl=document.getElementById('min'),secEl=document.getElementById('sec'),dayEl=document.getElementById('day'),hourEl=document.getElementById('hour'),msecEl=document.getElementById('msec'),yearEl=document.getElementById('year'),monthEl=document.getElementById('month'),dateEl=document.getElementById('date'),dayOfWeekEl=document.getElementById('day-of-week'),currentHourEl=document.getElementById('current-hour'),currentMinEl=document.getElementById('current-min'),currentSecEl=document.getElementById('current-sec'),currentMsecEl=document.getElementById('current-msec'),dayLabelEl=document.getElementById('day-label'),hourLabelEl=document.getElementById('hour-label'),currentHmsEl=document.getElementById('current-hms');
        const studyDisplayEl = document.getElementById('study-timer-display');
        const btnShow100s = document.getElementById('btn-show-100s');
        const btnStartPause = document.getElementById('btn-start-pause');
        const studyRepeatsTotalEl = document.getElementById('study-repeats-total');
        const studyRepeatsCompletedEl = document.getElementById('study-repeats-completed');
        const studyProgramNumberEl = document.getElementById('study-program-number');
        
        /*******************************************************************
         * 2. 共通テストタイマー関連
         *******************************************************************/
        
        const targetDate = new Date("2026-01-17T00:00:00");
        const holidays = ['2025-01-01', '2025-01-13', '2025-02-11', '2025-02-24', '2025-03-20','2025-04-29', '2025-05-03', '2025-05-04', '2025-05-05', '2025-05-06','2025-07-21', '2025-08-11', '2025-09-15', '2025-09-23', '2025-10-13','2025-11-03', '2025-11-24'];
        const weekdays = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];
        let currentDays = 0, remainingHolidays = 0;
        let lastCheckedDate = null, lastSecond = -1, highlightUntil = 0;

        function calculateRemainingHolidays(target) {
            let holidayCount = 0; const today = new Date(); today.setHours(0, 0, 0, 0);
            for (let d = today; d < target; d.setDate(d.getDate() + 1)) {
                const dayOfWeek = d.getDay();
                const dateString = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                if (dayOfWeek === 0 || dayOfWeek === 6 || holidays.includes(dateString)) { holidayCount++; }
            }
            return holidayCount;
        }

        function updateCountdownTimer() {
            const now = new Date();
            if (now.getDate() !== lastCheckedDate) { remainingHolidays = calculateRemainingHolidays(targetDate); lastCheckedDate = now.getDate(); }
            const diff = targetDate.getTime() - now.getTime();
            if (diff > 0) {
                const days = Math.floor(diff/864e5), hours = Math.floor(diff%864e5/36e5), mins = Math.floor(diff%36e5/6e4), secs = Math.floor(diff%6e4/1e3), msecs = diff%1e3;
                currentDays = days;
                minEl.textContent = String(mins).padStart(2,"0"); secEl.textContent = String(secs).padStart(2,"0"); dayEl.textContent = String(days);
                hourEl.textContent = String(hours).padStart(2,"0"); msecEl.textContent = String(msecs).padStart(3,"0");
                dayLabelEl.textContent = 1 === days ? "Day" : "Days"; hourLabelEl.textContent = 1 === hours ? "Hour" : "Hours";
            }
            const currentHour = now.getHours(), currentMin = now.getMinutes(), currentSec = now.getSeconds();
            yearEl.textContent = String(now.getFullYear()).padStart(4,"0"); monthEl.textContent = String(now.getMonth()+1).padStart(2,"0"); dateEl.textContent = String(now.getDate()).padStart(2,"0");
            dayOfWeekEl.textContent = weekdays[now.getDay()]; currentHourEl.textContent = String(currentHour).padStart(2,"0"); currentMinEl.textContent = String(currentMin).padStart(2,"0");
            currentSecEl.textContent = String(currentSec).padStart(2,"0"); currentMsecEl.textContent = Math.floor(now.getMilliseconds()/100);
            if (currentSec !== lastSecond) { if (currentMin === 59 && (currentSec >= 57)) { highlightUntil = now.getTime() + 100; } lastSecond = currentSec; }
            const isJihou = (currentMin === 0 && currentSec < 5), isHighlighted = now.getTime() < highlightUntil;
            isJihou || isHighlighted ? currentHmsEl.classList.add("jihou-highlight") : currentHmsEl.classList.remove("jihou-highlight");
        }

        /*******************************************************************
         * 3. ランダムメッセージ関連
         *******************************************************************/
        
        const randomMessages = ["キョウツウテストマデ アト DDDニチ!","シッテタ? キュウジツハアトddニチシカナインダヨ!","ナニヤッテルンデスカ、 ベンキョウシテクダサイ!","ガンバルアナタヲ オウエンシテイマス。","ヒトヤスミモ ダイジデスヨ。","モウコウコウモ オワッチャウネェ","トキノナガレハ ハヤイモノダヨ","ハナレバナレニ ナッテシマウノカナ...","ベンキョウ ガンバレヨ!","イママデノドリョクヲシンジテ。","キミナラデキル!","ラストスパートダ!","サイコウノハルヲムカエヨウ!","ムリシスギナイデネ。","ヒトリジャナイヨ。","アトスコシノシンボウ...","コンディションヲトトノエテ。","ケッカハカナラズツイテクル。","オワッタラ パーットアソボウゼ!"];
        const TYPING_SPEED = 150, DELETING_SPEED = 100, GREETING_STAY_DURATION = 5000;

        async function messageCycle() {
            if (currentTimerMode !== 'countdown') return;
            const type = async text => { for(let i=0; i < text.length; i++) { if (currentTimerMode !== 'countdown') { messageEl.textContent = ''; return false; } messageEl.textContent = text.substring(0, i + 1); await sleep(TYPING_SPEED); } return true; };
            const del = async () => { const currentText = messageEl.textContent; for(let i = currentText.length; i > 0; i--) { if (currentTimerMode !== 'countdown') { messageEl.textContent = ''; return false; } messageEl.textContent = currentText.substring(0, i - 1); await sleep(DELETING_SPEED); } return true; };
            const hour = new Date().getHours();
            let greeting = (hour >= 5 && hour < 10) ? "オハヨウゴザイマス" : (hour >= 10 && hour < 17) ? "コンニチハ" : "コンバンワ";
            if (!await type(greeting)) return;
            await sleep(GREETING_STAY_DURATION);
            if (!await del()) return;
            let rawMsg = randomMessages[Math.floor(Math.random() * randomMessages.length)];
            let processedMsg = rawMsg.replace('DDD', currentDays).replace('dd', remainingHolidays);
            if (!await type(processedMsg)) return;
            await sleep(5000 + Math.random() * 5000);
            if (!await del()) return;
        }

        async function runMessageLoop() {
            while (true) {
                if (currentTimerMode === 'countdown') { await messageCycle(); }
                await sleep(500);
            }
        }
        
        /*******************************************************************
         * 4. 時間割タイマー関連
         *******************************************************************/

        const subjects = ["Break", "Modern-Japanese", "Old-Japanese", "Old-Chinese", "Mathematics", "English", "Japan History", "World History", "Geography", "Physics", "Biology", "Science", "Information", "RANDOM"];
        let currentSubjectIndex = 0;
        let studyTimerState = 'setting', programs = [], settingTime = 0, runningTime = 0;
        let currentProgramIndex = 0, totalRepeats = 1, completedRepeats = 0;
        let showHundredths = false, timerInterval = null, isSettingProgram = false;
        
        // --- ▼▼▼ JS変更箇所 ▼▼▼ ---
        // Web Workerを使わずにバックグラウンドでもタイマーの精度を保つための実装
        let expectedEndTime = 0; 
        // --- ▲▲▲ JS変更箇所ここまで ▲▲▲

        const chimeSound = new Audio('Chime.wav');
        function playChime() {
            chimeSound.currentTime = 0;
            chimeSound.play().catch(error => console.error("音声の再生に失敗しました:", error));
        }

        function updateStudyTimerDisplay() {
            let timeToShow = (studyTimerState === 'setting') ? settingTime * 1000 : runningTime;
            if (timeToShow < 0) timeToShow = 0;
            const totalSeconds = Math.floor(timeToShow / 1000), minutes = Math.floor(totalSeconds / 60), seconds = totalSeconds % 60, hundredths = Math.floor((timeToShow % 1000) / 10);
            studyDisplayEl.textContent = (showHundredths && totalSeconds < 60 && studyTimerState !== 'setting') ? `${String(seconds).padStart(2, '0')}.${String(hundredths).padStart(2, '0')}` : `${String(minutes).padStart(2, '!')}:${String(seconds).padStart(2, '0')}`;
            let programNumberToShow = (studyTimerState === 'setting') ? programs.length + 1 : currentProgramIndex + 1;
            const programNumberDigits = String(programNumberToShow).padStart(2, '0');
            let displayRepeats = (totalRepeats !== 0 && completedRepeats > totalRepeats) ? totalRepeats : completedRepeats;
            studyRepeatsTotalEl.textContent = String(totalRepeats).padStart(3, '!');
            if (displayRepeats >= 100) {
                const hundreds = Math.floor(displayRepeats / 100) % 10, tens = Math.floor(displayRepeats / 10) % 10, ones = displayRepeats % 10;
                studyRepeatsCompletedEl.textContent = `${hundreds}${tens}`;
                studyProgramNumberEl.innerHTML = `<span style="color:red;">${ones}</span>${programNumberDigits}`;
            } else {
                studyRepeatsCompletedEl.textContent = totalRepeats === 0 ? '!!' : String(displayRepeats).padStart(2, '!');
                studyProgramNumberEl.innerHTML = '';
                studyProgramNumberEl.textContent = `P${programNumberDigits}`;
            }
        }
        
        function updateSubjectDisplay() {
            if (studyTimerState === 'setting' && !isSettingProgram) {
                messageEl.textContent = subjects[currentSubjectIndex];
            }
        }

        function updateRunningMessage() {
            if (!['running', 'paused', 'finished'].includes(studyTimerState) || programs.length === 0) return;
            const currentProgram = programs[currentProgramIndex];
            if (currentProgram.subject === "Break") {
                const nextIndex = (currentProgramIndex + 1) % programs.length;
                const nextSubject = programs[nextIndex].subject;
                messageEl.style.fontSize = '29px';
                messageEl.textContent = `Break  (NEXT: ${nextSubject})`;
            } else {
                messageEl.style.fontSize = '';
                messageEl.textContent = currentProgram.subject;
            }
        }
        
        function timerTick() {
            // --- ▼▼▼ JS変更箇所 ▼▼▼ ---
            // 経過時間から残り時間を再計算し、タイマーのズレを補正
            runningTime = expectedEndTime - Date.now();
            // --- ▲▲▲ JS変更箇所ここまで ▲▲▲

            if (runningTime <= 0) {
                playChime();
                currentProgramIndex++;
                if (currentProgramIndex >= programs.length) {
                    currentProgramIndex = 0;
                    completedRepeats++;
                    if (totalRepeats !== 0 && completedRepeats >= totalRepeats) {
                        studyTimerState = 'finished';
                        clearInterval(timerInterval);
                        runningTime = 0;
                        messageEl.textContent = 'Your work is finished today!';
                        messageEl.style.fontSize = '';
                        btnStartPause.textContent = 'Finished';
                        updateStudyTimerDisplay();
                        return;
                    }
                }
                if (studyTimerState !== 'finished') {
                    runningTime = programs[currentProgramIndex].time * 1000;
                    expectedEndTime = Date.now() + runningTime; // 次の目標時刻をセット
                    updateRunningMessage();
                }
            }
            updateStudyTimerDisplay();
        }

        function handleTimeChange(seconds) {
            if (studyTimerState !== 'setting' || isSettingProgram) return;
            settingTime += seconds;
            if (settingTime < 0) settingTime = 0;
            if (settingTime > 5999) settingTime = 5999;
            updateStudyTimerDisplay();
        }

        function handleRepeatChange(amount) {
            if (studyTimerState !== 'setting' || isSettingProgram) return;
            totalRepeats += amount;
            if (totalRepeats < 1) totalRepeats = 1;
            if (totalRepeats > 999) totalRepeats = 999;
            updateStudyTimerDisplay();
        }

        function resetStudyTimer() {
            clearInterval(timerInterval);
            studyTimerState = 'setting';
            programs = []; settingTime = 0; runningTime = 0;
            currentProgramIndex = 0; completedRepeats = 0;
            totalRepeats = 1;
            btnStartPause.textContent = 'Start';
            btnStartPause.classList.remove('toggled');
            messageEl.style.fontSize = '';
            currentSubjectIndex = 0;
            updateStudyTimerDisplay();
            updateSubjectDisplay();
        }
        
        /*******************************************************************
         * 5. メイン制御・初期化
         *******************************************************************/

        // --- ▼▼▼ JS変更箇所 ▼▼▼ ---
        // ボタン長押し高速化の汎用関数
        function makeButtonAccelerate(element, action) {
            let timeoutId, intervalId;
            const startAction = (e) => {
                e.preventDefault(); // スマホでの長押し時のメニュー表示などを防ぐ
                action();
                timeoutId = setTimeout(() => {
                    intervalId = setInterval(action, 100); // 0.1秒ごとに実行
                }, 500); // 0.5秒後に加速開始
            };
            const stopAction = () => {
                clearTimeout(timeoutId);
                clearInterval(intervalId);
            };
            element.addEventListener('mousedown', startAction);
            element.addEventListener('mouseup', stopAction);
            element.addEventListener('mouseleave', stopAction);
            element.addEventListener('touchstart', startAction);
            element.addEventListener('touchend', stopAction);
        }
        // --- ▲▲▲ JS変更箇所ここまで ▲▲▲

        function setupEventListeners() {
            // モード切替
            switchBtn.addEventListener('click', () => {
                if (currentTimerMode === 'countdown') {
                    currentTimerMode = 'study';
                    messageEl.textContent = '';
                    countdownContainer.style.display = 'none';
                    studyTimerContainer.style.display = 'block';
                    switchBtn.textContent = '共通テストタイマーへ';
                    messageEl.classList.add('subject-mode');
                    resetStudyTimer();
                } else {
                    currentTimerMode = 'countdown';
                    messageEl.textContent = '';
                    countdownContainer.style.display = 'block';
                    studyTimerContainer.style.display = 'none';
                    switchBtn.textContent = '時間割タイマーへ';
                    messageEl.classList.remove('subject-mode');
                    messageEl.style.fontSize = '';
                }
            });

            // --- ▼▼▼ JS変更箇所 ▼▼▼ ---
            // 時間割タイマー：コントロール（長押し対応）
            makeButtonAccelerate(document.getElementById('btn-plus-10m'), () => handleTimeChange(600));
            makeButtonAccelerate(document.getElementById('btn-plus-1m'), () => handleTimeChange(60));
            makeButtonAccelerate(document.getElementById('btn-plus-1s'), () => handleTimeChange(1));
            makeButtonAccelerate(document.getElementById('btn-minus-10m'), () => handleTimeChange(-600));
            makeButtonAccelerate(document.getElementById('btn-minus-1m'), () => handleTimeChange(-60));
            makeButtonAccelerate(document.getElementById('btn-minus-1s'), () => handleTimeChange(-1));
            makeButtonAccelerate(document.getElementById('btn-repeat-plus'), () => handleRepeatChange(1));
            makeButtonAccelerate(document.getElementById('btn-repeat-minus'), () => handleRepeatChange(-1));
            
            // 長押し非対応のボタン
            document.getElementById('btn-reset').addEventListener('click', resetStudyTimer);
            btnShow100s.addEventListener('click', () => {
                showHundredths = !showHundredths;
                btnShow100s.classList.toggle('toggled', showHundredths);
                updateStudyTimerDisplay();
            });
            // --- ▲▲▲ JS変更箇所ここまで ▲▲▲

            document.getElementById('btn-next-subject').addEventListener('click', () => {
                if (studyTimerState !== 'setting' || isSettingProgram) return;
                currentSubjectIndex = (currentSubjectIndex + 1) % subjects.length;
                updateSubjectDisplay();
            });
            document.getElementById('btn-prev-subject').addEventListener('click', () => {
                if (studyTimerState !== 'setting' || isSettingProgram) return;
                currentSubjectIndex = (currentSubjectIndex - 1 + subjects.length) % subjects.length;
                updateSubjectDisplay();
            });
            
            // P-Set
            document.getElementById('btn-pset').addEventListener('click', async () => {
                if (studyTimerState !== 'setting' || settingTime === 0 || programs.length >= 99 || isSettingProgram) return;
                isSettingProgram = true;
                let subjectToSet = subjects[currentSubjectIndex];
                if (subjectToSet === 'RANDOM') {
                    const candidateSubjects = subjects.filter(s => s !== 'Break' && s !== 'RANDOM');
                    subjectToSet = candidateSubjects[Math.floor(Math.random() * candidateSubjects.length)];
                }
                programs.push({ time: settingTime, subject: subjectToSet });
                const programNumberStr = String(programs.length).padStart(2, '0');
                messageEl.textContent = `P${programNumberStr} is set to ${subjectToSet}`;
                settingTime = 0;
                updateStudyTimerDisplay();
                await sleep(2000);
                currentSubjectIndex = 0;
                isSettingProgram = false;
                updateSubjectDisplay();
            });

            // Start/Pause/Resume
            btnStartPause.addEventListener('click', () => {
                if (isSettingProgram || studyTimerState === 'finished') return;
                if (studyTimerState === 'setting') {
                    if (programs.length === 0 && settingTime > 0) {
                        let subjectToSet = subjects[currentSubjectIndex];
                        if (subjectToSet === 'RANDOM') {
                            const candidateSubjects = subjects.filter(s => s !== 'Break' && s !== 'RANDOM');
                            subjectToSet = candidateSubjects[Math.floor(Math.random() * candidateSubjects.length)];
                        }
                        programs.push({ time: settingTime, subject: subjectToSet });
                        settingTime = 0;
                    }
                    if (programs.length === 0) return;
                    studyTimerState = 'running';
                    currentProgramIndex = 0;
                    completedRepeats = 0;
                    updateStudyTimerDisplay();
                    completedRepeats = 1;
                    runningTime = programs[0].time * 1000;
                    expectedEndTime = Date.now() + runningTime; // 目標時刻をセット
                    updateRunningMessage();
                    timerInterval = setInterval(timerTick, 10);
                    btnStartPause.textContent = 'Pause';
                    btnStartPause.classList.add('toggled');
                } else if (studyTimerState === 'running') {
                    studyTimerState = 'paused';
                    clearInterval(timerInterval);
                    runningTime = expectedEndTime - Date.now(); // 残り時間を正確に保存
                    btnStartPause.textContent = 'Resume';
                } else if (studyTimerState === 'paused') {
                    studyTimerState = 'running';
                    expectedEndTime = Date.now() + runningTime; // 新しい目標時刻をセット
                    timerInterval = setInterval(timerTick, 10);
                    btnStartPause.textContent = 'Pause';
                }
            });
        }

        function initialize() {
            countdownContainer.style.display = 'block';
            setInterval(updateCountdownTimer, 1);
            runMessageLoop();
            resetStudyTimer();
            setupEventListeners();
        }
        
        initialize();

    </script>
</body>
</html>